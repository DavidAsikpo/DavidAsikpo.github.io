/* ============================================================
   GOLD LAYER: STAR SCHEMA VIEWS (dim_customers, dim_products, fact_sales)
   ============================================================

   This script creates the **Gold Layer** of the Data Warehouse 
   using views that represent the final star schema model for BI and analytics.

   - dim_customers: Cleanses and standardizes customer information 
     (joins customer, demographic, and location data).
   - dim_products: Provides enriched product details 
     (joins product info with product categories and filters active products).
   - fact_sales: Fact table that links sales transactions 
     with customers and products for analytical reporting.

   ⚠️ WARNING:
   These views reference the Silver layer. 
   Ensure that all **Silver_Datawarehouse tables** are loaded 
   before running this script, otherwise the views will fail.

   Purpose:
   - Provide a **business-friendly schema** for reporting.
   - Enable star schema analytics (facts + dimensions).
   - Standardize keys with surrogate keys (ROW_NUMBER).
============================================================ */
CREATE VIEW Gold_Datawarehouse.dim_customers AS
SELECT 
ROW_NUMBER() OVER (ORDER BY ci.cst_id) AS customer_key,
 ci.cst_id AS customer_id,
 ci.cst_key AS customer_number,
 ci.cst_firstname AS first_name,
 ci.cst_lastname AS last_name,
 la.cntry AS country,
 ci.cst_marital_status AS marital_status,
 CASE WHEN ci.cst_gndr != 'n/a' THEN ci.cst_gndr
	ELSE COALESCE(ca.gen, 'n/a')
END AS gender,
 ca.bdate AS birthdate,
 ci.cst_create_date AS create_date
 FROM Silver_Datawarehouse.crm_cust_info ci
 LEFT JOIN silver_Datawarehouse.erp_cust_az12 ca
 ON ci.cst_key = ca.cid
 LEFT JOIN silver_Datawarehouse.erp_loc_a101 la
 ON ci.cst_key = la.cid;
 
 
 CREATE VIEW Gold_Datawarehouse.dim_products AS
 SELECT 
 ROW_NUMBER() OVER (ORDER BY pn.prd_start_dt, pn.prd_key ) AS product_key,
 pn.prd_id AS product_id,
 pn.prd_key AS product_number,
 pn.prd_nm AS product_name,
 pn.cat_id AS category_id,
 pc.cat AS category,
 pc.subcat AS subcategory,
 pc.maintenance AS maintenance,
 pn.prd_cost AS product_cost,
 pn.prd_line AS product_line,
 pn.prd_start_dt AS start_date
 FROM Silver_DataWarehouse.crm_Prd_info pn
 LEFT JOIN Silver_Datawarehouse.erp_cat_g1v2 pc
 ON pn.cat_id = pc.id
 WHERE prd_end_dt IS NULL;
 

CREATE VIEW Gold_Datawarehouse.fact_sales AS
SELECT 
sd.sls_ord_num AS order_key,
pr.product_key,
cu.customer_Key,
sd.sls_order_dt AS order_date,
sd.sls_ship_dt AS shipping_date,
sd.sls_due_dt AS due_date,
sd.sls_sales AS sales_amount,
sd.sls_quantity AS quantity,
sd.sls_price AS price
FROM Silver_Datawarehouse.crm_sales_details sd
LEFT JOIN Gold_Datawarehouse.dim_products pr
ON sd.sls_Prd_key = pr.product_number
LEFT JOIN Gold_Datawarehouse.dim_customers cu
ON sd.sls_cust_id = cu.customer_id;



Description:
 This script truncates existing tables (if data already exists in them) 
 and reloads fresh data from CSV files into the Bronze Datawarehouse schema.  
 It uses **LOAD DATA LOCAL INFILE** for bulk inserts, which makes loading faster and 
 more efficient compared to row-by-row inserts.

 Features:
 1. Truncates each target table before loading to ensure clean data reloads.
 2. Uses LOCAL INFILE for bulk CSV imports.
 3. Captures and displays the load duration (in seconds) for each table.
 4. Handles errors gracefully:
    - Displays error number, SQLSTATE, and detailed error message if an exception occurs.
 5. Separates CRM and ERP tables clearly during the load process.

 Notes:
 - In this same **Bronze** folder, there is a **Python script** that performs 
   the exact same procedure. This was added as a fallback for Mac users, since 
   MySQL’s LOCAL INFILE can sometimes be restricted or tricky on macOS.  
   The Python script handles the truncation + CSV load logic, 
   also tracks load durations, and prints any errors encountered.

 Usage:
 Run this script in MySQL Workbench or CLI.  
 Make sure LOCAL INFILE is enabled in your MySQL configuration and that 
 file paths are correct for your environment.
**********************************************************************************************/

DELIMITER $$

BEGIN
    DECLARE start_time DATETIME;
    DECLARE end_time DATETIME;
    DECLARE err_number INT DEFAULT 0;
    DECLARE err_msg TEXT;
    DECLARE err_sqlstate CHAR(5);

    -- Error handler
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        GET DIAGNOSTICS CONDITION 1
            err_number = MYSQL_ERRNO,
            err_msg = MESSAGE_TEXT,
            err_sqlstate = RETURNED_SQLSTATE;
        
        SELECT CONCAT('Error Number: ', err_number) AS message;
        SELECT CONCAT('SQLSTATE: ', err_sqlstate) AS message;
        SELECT CONCAT('Error Message: ', err_msg) AS message;
    END;

    -- ---------------------------------------------------
    -- Loading CRM Tables
    -- ---------------------------------------------------

    SET start_time = NOW();
    TRUNCATE TABLE Bronze_Datawarehouse.crm_cust_info;
    LOAD DATA LOCAL INFILE '/Users/mac/Downloads/sql-data-warehouse-project 2/datasets/source_crm/cust_info.csv'
        INTO TABLE Bronze_Datawarehouse.crm_cust_info
        FIELDS TERMINATED BY ','
        LINES TERMINATED BY '\n'
        IGNORE 1 ROWS;
    SET end_time = NOW();
    SELECT CONCAT('crm_cust_info Load Duration: ', TIMESTAMPDIFF(SECOND, start_time, end_time), ' Seconds') AS message;

    SET start_time = NOW();
    TRUNCATE TABLE Bronze_Datawarehouse.crm_prd_info;
    LOAD DATA LOCAL INFILE '/Users/mac/Downloads/sql-data-warehouse-project 2/datasets/source_crm/prd_info.csv'
        INTO TABLE Bronze_Datawarehouse.crm_prd_info
        FIELDS TERMINATED BY ','
        LINES TERMINATED BY '\n'
        IGNORE 1 ROWS;
    SET end_time = NOW();
    SELECT CONCAT('crm_prd_info Load Duration: ', TIMESTAMPDIFF(SECOND, start_time, end_time), ' Seconds') AS message;

    SET start_time = NOW();
    TRUNCATE TABLE Bronze_Datawarehouse.crm_sales_details;
    LOAD DATA LOCAL INFILE '/Users/mac/Downloads/sql-data-warehouse-project 2/datasets/source_crm/sales_details.csv'
        INTO TABLE Bronze_Datawarehouse.crm_sales_details
        FIELDS TERMINATED BY ','
        LINES TERMINATED BY '\n'
        IGNORE 1 ROWS;
    SET end_time = NOW();
    SELECT CONCAT('crm_sales_details Load Duration: ', TIMESTAMPDIFF(SECOND, start_time, end_time), ' Seconds') AS message;

    -- ---------------------------------------------------
    -- Loading ERP Tables
    -- ---------------------------------------------------

    SET start_time = NOW();
    TRUNCATE TABLE Bronze_Datawarehouse.erp_cat_g1v2;
    LOAD DATA LOCAL INFILE '/Users/mac/Downloads/sql-data-warehouse-project 2/datasets/source_crm/PX_CAT_GIV2erp_cust_az12.csv'
        INTO TABLE Bronze_Datawarehouse.erp_cat_g1v2
        FIELDS TERMINATED BY ','
        LINES TERMINATED BY '\n'
        IGNORE 1 ROWS;
    SET end_time = NOW();
    SELECT CONCAT('erp_cat_g1v2 Load Duration: ', TIMESTAMPDIFF(SECOND, start_time, end_time), ' Seconds') AS message;

    SET start_time = NOW();
    TRUNCATE TABLE Bronze_Datawarehouse.erp_cust_az12;
    LOAD DATA LOCAL INFILE '/Users/mac/Downloads/sql-data-warehouse-project 2/datasets/source_erp/CUST_AZ12.csv'
        INTO TABLE Bronze_Datawarehouse.erp_cust_az12
        FIELDS TERMINATED BY ','
        LINES TERMINATED BY '\n'
        IGNORE 1 ROWS;
    SET end_time = NOW();
    SELECT CONCAT('erp_cust_az12 Load Duration: ', TIMESTAMPDIFF(SECOND, start_time, end_time), ' Seconds') AS message;

    SET start_time = NOW();
    TRUNCATE TABLE Bronze_Datawarehouse.erp_loc_a101;
    LOAD DATA LOCAL INFILE '/Users/mac/Downloads/sql-data-warehouse-project 2/datasets/source_erp/LOC_A101.csv'
        INTO TABLE Bronze_Datawarehouse.erp_loc_a101
        FIELDS TERMINATED BY ','
        LINES TERMINATED BY '\n'
        IGNORE 1 ROWS;
    SET end_time = NOW();
    SELECT CONCAT('erp_loc_a101 Load Duration: ', TIMESTAMPDIFF(SECOND, start_time, end_time), ' Seconds') AS message;

END$$

DELIMITER ;
